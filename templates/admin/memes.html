{% extends "admin/dashboard.html" %}

{% block title %}Все мемы - MemePlatform{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-lg-2">
        <div class="sidebar">
            <h6 class="text-muted mb-3">АДМИН-ПАНЕЛЬ</h6>
            <nav class="admin-nav">
                <a class="nav-link" href="/admin">
                    <i class="bi bi-speedometer2"></i> Дашборд
                </a>
                <a class="nav-link" href="/admin/moderation">
                    <i class="bi bi-hourglass-split"></i> Модерация
                </a>
                <a class="nav-link active" href="/admin/memes">
                    <i class="bi bi-collection"></i> Все мемы
                </a>
                <a class="nav-link" href="/admin/categories">
                    <i class="bi bi-folder"></i> Категории
                </a>
                <a class="nav-link" href="/admin/users">
                    <i class="bi bi-people"></i> Пользователи
                </a>
                <a class="nav-link" href="/admin/reports">
                    <i class="bi bi-flag"></i> Жалобы
                </a>
            </nav>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="col-lg-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-collection text-primary"></i> Все мемы</h2>
            
            <div class="btn-group">
                <button class="btn btn-danger" onclick="bulkDelete()">
                    <i class="bi bi-trash"></i> Удалить выбранные
                </button>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <form class="row g-3" method="GET">
                    <div class="col-md-3">
                        <select name="status" class="form-select">
                            <option value="">Все статусы</option>
                            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>На модерации</option>
                            <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Одобренные</option>
                            <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Отклоненные</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select name="category" class="form-select">
                            <option value="">Все категории</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if category_filter == cat.id %}selected{% endif %}>
                                {{ cat.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" name="search" class="form-control" 
                               placeholder="Поиск..." value="{{ search_query or '' }}">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Найти
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Memes Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" class="form-check-input" id="selectAll">
                                </th>
                                <th>Превью</th>
                                <th>Название</th>
                                <th>Категория</th>
                                <th>Автор</th>
                                <th>Статус</th>
                                <th>Лайки</th>
                                <th>Просмотры</th>
                                <th>Дата</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for meme in memes %}
                            <tr id="row-{{ meme.id }}">
                                <td>
                                    <input type="checkbox" class="form-check-input meme-checkbox" 
                                           value="{{ meme.id }}">
                                </td>
                                <td>
                                    {% if meme.file_type == 'video' %}
                                    <video src="/data/uploads/{{ meme.filename }}" 
                                           style="width: 60px; height: 45px; object-fit: cover; border-radius: 4px;" muted></video>
                                    {% else %}
                                    <img src="/data/uploads/{{ meme.filename }}" 
                                         style="width: 60px; height: 45px; object-fit: cover; border-radius: 4px;">
                                    {% endif %}
                                </td>
                                <td>{{ meme.title[:25] + '...' if meme.title and meme.title|length > 25 else meme.title or '-' }}</td>
                                <td>
                                    {% if meme.category_name %}
                                    <span class="badge bg-primary">{{ meme.category_name }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ meme.author_name or 'Аноним' }}</td>
                                <td>
                                    {% if meme.status == 'pending' %}
                                    <span class="badge bg-warning">Ожидает</span>
                                    {% elif meme.status == 'approved' %}
                                    <span class="badge bg-success">Одобрен</span>
                                    {% else %}
                                    <span class="badge bg-danger">Отклонен</span>
                                    {% endif %}
                                </td>
                                <td>{{ meme.likes_count or 0 }}</td>
                                <td>{{ meme.views_count or 0 }}</td>
                                <td>{{ meme.created_at[:10] if meme.created_at else '' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/meme/{{ meme.id }}" class="btn btn-outline-primary" target="_blank">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% if meme.status == 'pending' %}
                                        <button class="btn btn-success btn-approve" data-id="{{ meme.id }}">
                                            <i class="bi bi-check"></i>
                                        </button>
                                        <button class="btn btn-warning btn-reject" data-id="{{ meme.id }}">
                                            <i class="bi bi-x"></i>
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-danger btn-delete" data-id="{{ meme.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if total_pages > 1 %}
                <nav class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% for p in range(1, total_pages + 1) %}
                        <li class="page-item {% if p == page %}active{% endif %}">
                            <a class="page-link" href="?page={{ p }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}">{{ p }}</a>
                        </li>
                        {% endfor %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Select all checkbox
    document.getElementById('selectAll').addEventListener('change', function() {
        document.querySelectorAll('.meme-checkbox').forEach(cb => cb.checked = this.checked);
    });
    
    document.querySelectorAll('.btn-approve').forEach(btn => {
        btn.addEventListener('click', async function() {
            const res = await fetch(`/api/admin/meme/${this.dataset.id}/approve`, {method: 'POST'});
            if (res.ok) location.reload();
        });
    });
    
    document.querySelectorAll('.btn-reject').forEach(btn => {
        btn.addEventListener('click', async function() {
            const reason = prompt('Причина отклонения:');
            const res = await fetch(`/api/admin/meme/${this.dataset.id}/reject`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({reason: reason || ''})
            });
            if (res.ok) location.reload();
        });
    });
    
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (!confirm('Удалить мем?')) return;
            const res = await fetch(`/api/admin/meme/${this.dataset.id}`, {method: 'DELETE'});
            if (res.ok) document.getElementById('row-' + this.dataset.id).remove();
        });
    });
    
    async function bulkDelete() {
        const ids = Array.from(document.querySelectorAll('.meme-checkbox:checked')).map(cb => parseInt(cb.value));
        if (!ids.length) {
            alert('Выберите мемы');
            return;
        }
        if (!confirm(`Удалить ${ids.length} мем(ов)?`)) return;
        
        const res = await fetch('/api/admin/bulk/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ids: ids})
        });
        if (res.ok) location.reload();
    }
</script>
{% endblock %}
