{% extends "admin/dashboard.html" %}

{% block title %}–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ - MemePlatform{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-lg-2">
        <div class="sidebar">
            <h6 class="text-muted mb-3">–ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨</h6>
            <nav class="admin-nav">
                <a class="nav-link" href="/admin">
                    <i class="bi bi-speedometer2"></i> –î–∞—à–±–æ—Ä–¥
                </a>
                <a class="nav-link" href="/admin/moderation">
                    <i class="bi bi-hourglass-split"></i> –ú–æ–¥–µ—Ä–∞—Ü–∏—è
                </a>
                <a class="nav-link" href="/admin/memes">
                    <i class="bi bi-collection"></i> –í—Å–µ –º–µ–º—ã
                </a>
                <a class="nav-link active" href="/admin/categories">
                    <i class="bi bi-folder"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
                </a>
                <a class="nav-link" href="/admin/users">
                    <i class="bi bi-people"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                </a>
                <a class="nav-link" href="/admin/reports">
                    <i class="bi bi-flag"></i> –ñ–∞–ª–æ–±—ã
                </a>
            </nav>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="col-lg-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-folder text-primary"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
            
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                <i class="bi bi-plus-lg"></i> –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            </button>
        </div>
        
        {% if success %}
        <div class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle"></i> {{ success }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
        
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ò–∫–æ–Ω–∫–∞</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th>–ú–µ–º–æ–≤</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cat in categories %}
                            <tr>
                                <td>{{ cat.id }}</td>
                                <td style="font-size: 1.5rem;">{{ cat.icon or 'üìÅ' }}</td>
                                <td>{{ cat.name }}</td>
                                <td>{{ cat.description or '-' }}</td>
                                <td><span class="badge bg-primary">{{ cat.meme_count or 0 }}</span></td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary btn-edit-cat" 
                                                data-id="{{ cat.id }}" 
                                                data-name="{{ cat.name }}" 
                                                data-icon="{{ cat.icon or '' }}" 
                                                data-desc="{{ cat.description or '' }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        {% if cat.meme_count == 0 %}
                                        <button class="btn btn-outline-danger btn-delete-cat" data-id="{{ cat.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/admin/categories">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–ò–∫–æ–Ω–∫–∞ (—ç–º–æ–¥–∑–∏)</label>
                        <input type="text" name="icon" class="form-control" placeholder="üòÄ" maxlength="10">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                        <input type="text" name="name" class="form-control" required maxlength="50">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea name="description" class="form-control" rows="2" maxlength="200"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/admin/categories" id="editForm">
                <input type="hidden" name="id" id="editId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–ò–∫–æ–Ω–∫–∞ (—ç–º–æ–¥–∑–∏)</label>
                        <input type="text" name="icon" id="editIcon" class="form-control" maxlength="10">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                        <input type="text" name="name" id="editName" class="form-control" required maxlength="50">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea name="description" id="editDescription" class="form-control" rows="2" maxlength="200"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.querySelectorAll('.btn-edit-cat').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('editId').value = this.dataset.id;
            document.getElementById('editName').value = this.dataset.name;
            document.getElementById('editIcon').value = this.dataset.icon;
            document.getElementById('editDescription').value = this.dataset.desc;
            new bootstrap.Modal(document.getElementById('editCategoryModal')).show();
        });
    });
    
    document.querySelectorAll('.btn-delete-cat').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) return;
            const res = await fetch(`/api/admin/category/${this.dataset.id}`, {method: 'DELETE'});
            if (res.ok) location.reload();
        });
    });
</script>
{% endblock %}
